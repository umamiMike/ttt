<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Tic-Tac-Toe</title>
	<style>
		body {
			font-family: Arial, sans-serif;
			display: flex;
			flex-direction: column;
			align-items: center;
			margin-top: 50px;
		}

		h1 {
			margin-bottom: 20px;
		}

		#board {
			display: grid;
			grid-template-columns: repeat(3, 100px);
			grid-template-rows: repeat(3, 100px);
			gap: 5px;
		}

		.cell {
			display: flex;
			justify-content: center;
			align-items: center;
			font-size: 2.5rem;
			background-color: #f0f0f0;
			cursor: pointer;
			user-select: none;
		}

		.cell:hover {
			background-color: #ddd;
		}

		#status {
			margin-top: 20px;
		}

		#reset {
			margin-top: 10px;
			padding: 5px 15px;
			font-size: 1rem;
		}
	</style>
</head>

<body>

	<h1>Tic-Tac-Toe</h1>
	<div id="board"></div>
	<div id="status"></div>
	<div id="player_x"></div>
	<div id="player_y"></div>
	<button id="reset">Reset</button>
	<button id="query">query</button>

	<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
	<script>
		const client = mqtt.connect("ws://localhost:9001"); // Mosquitto WS listener

		client.on("connect", () => {
			console.log("Connected to broker!");
			client.subscribe("game/state", (err) => {
				if (!err) {
					msg = {action: "browser_connect", player: "", data: ""}
					client.publish("game/move", JSON.stringify(msg));
				}
			});
		});

		client.on("message", (topic, message) => {
			console.log(topic, message.toString());
		});

		client.on("error", (topic, message) => {
			console.log(topic, message.toString());
		});

		const boardElement = document.getElementById('board');
		const statusElement = document.getElementById('status');
		const player_x = document.getElementById('player_x');
		const resetButton = document.getElementById('reset');
		const query_button = document.getElementById('query');


		let board = Array(9).fill('');
		let bs = Array(9).fill(0);
		let currentPlayer = 'X';
		let gameOver = false;

		function playerInfo() {
			const name = "mike"
			const name_prompt = document.createElement('input');
			name_prompt.placeholder = "Player Name"
			name_prompt.addEventListener("keypress", (e) => {
				if (e.key === "Enter") {
					const name = document.createElement('div')
					name.textContent = name_prompt.value
					const par = name_prompt.parentElement
					par.appendChild(name)
					// name.textContent = name_prompt.value
					name_prompt.remove()
					join_game(name.textContent)
					makeClickable()
				}
			});
			player_x.appendChild(name_prompt)

		}
		function join_game(name) {
			msg = {action: "join", data: name}
			client.publish("game/move", JSON.stringify(msg), {qos: 1});
		}
		function initBoard() {
			boardElement.innerHTML = '';
			board.forEach((cell, i) => {
				const cellDiv = document.createElement('div');
				cellDiv.classList.add('cell');
				cellDiv.textContent = cell;
				boardElement.appendChild(cellDiv);
			});
		}
		function makeClickable() {
			cells = document.querySelectorAll('.cell')
			console.log(cells)
			cells.forEach((cell, i) => {
				cell.addEventListener('click', () => handleMove(i));
			});
		}

		function handleMove(index) {
			console.log(index)
			const px = document.getElementById("player_x")
			const name = px.textContent
			msg = {action: "take_turn", data: {player: name, cell: index}}
			client.publish("game/move", JSON.stringify(msg), {qos: 1});
		}

		function checkWin(player) {
		}

		resetButton.addEventListener('click', () => {
			board = Array(9).fill('');
			currentPlayer = 'X';
			gameOver = false;
			statusElement.textContent = `Next turn: ${currentPlayer}`;
			renderBoard();
		});

		query_button.addEventListener('click', (e) => {
			bn = board.map(item => {return item === "X" ? 1 : item === "O" ? -1 : 0})
			client.publish("game/state", JSON.stringify(bn), {qos: 1});

		});
		// Initial render
		initBoard();
		playerInfo();
		statusElement.textContent = `Next turn: ${currentPlayer}`;
	</script>

</body>

</html>
